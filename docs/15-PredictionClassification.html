<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>MLE 2023 - 15&nbsp; Prediction and Classification</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./16-ModelTypesSummary.html" rel="next">
<link href="./14-SurvivalData.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./15-PredictionClassification.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Prediction and Classification</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">MLE 2023</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Maxmimum Likelihood Fall 2023</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-ROverview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">R Overview</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-TheMATH.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">The Math</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-ReviewofOLS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Review of OLS</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-IntrotoMaximumLikelihood.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Introduction to MLE</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-BinaryOutcomes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Binary Dependent Variables</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-QuantitiesofInterest.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Quantities of Interest</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-OrdinalandOutcomes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Ordinal Outcomes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-NominalOutcomes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Multinomial Outcomes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-CountData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Count data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-SampleSelection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Sample Selection Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-PanelData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Panel and Hierarchical Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-SurveyData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Survey Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-SurvivalData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Survival Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-PredictionClassification.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Prediction and Classification</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-ModelTypesSummary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Linear Models</span></span></a>
  </div>
</li>
    </ul>
    </div>
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Section Contents</h2>
   
  <ul>
  <li><a href="#overview-of-prediction-and-classification" id="toc-overview-of-prediction-and-classification" class="nav-link active" data-scroll-target="#overview-of-prediction-and-classification"><span class="header-section-number">15.1</span> Overview of Prediction and Classification</a>
  <ul>
  <li><a href="#how-to-predict-or-classify" id="toc-how-to-predict-or-classify" class="nav-link" data-scroll-target="#how-to-predict-or-classify"><span class="header-section-number">15.1.1</span> How to predict or classify</a></li>
  </ul></li>
  <li><a href="#in-sample-vs.-out-of-sample" id="toc-in-sample-vs.-out-of-sample" class="nav-link" data-scroll-target="#in-sample-vs.-out-of-sample"><span class="header-section-number">15.2</span> In-sample vs.&nbsp;Out-of-Sample</a></li>
  <li><a href="#cross-validation" id="toc-cross-validation" class="nav-link" data-scroll-target="#cross-validation"><span class="header-section-number">15.3</span> Cross-Validation</a>
  <ul>
  <li><a href="#k-fold-cross-validation" id="toc-k-fold-cross-validation" class="nav-link" data-scroll-target="#k-fold-cross-validation"><span class="header-section-number">15.3.1</span> k-fold cross-validation</a></li>
  <li><a href="#leave-one-out-cross-validation" id="toc-leave-one-out-cross-validation" class="nav-link" data-scroll-target="#leave-one-out-cross-validation"><span class="header-section-number">15.3.2</span> Leave-one-out cross-validation</a></li>
  </ul></li>
  <li><a href="#examples-of-prediction-and-classification" id="toc-examples-of-prediction-and-classification" class="nav-link" data-scroll-target="#examples-of-prediction-and-classification"><span class="header-section-number">15.4</span> Examples of Prediction and Classification</a></li>
  <li><a href="#continuous-example" id="toc-continuous-example" class="nav-link" data-scroll-target="#continuous-example"><span class="header-section-number">15.5</span> Continuous Example</a></li>
  <li><a href="#tidymodels-and-cross-validation" id="toc-tidymodels-and-cross-validation" class="nav-link" data-scroll-target="#tidymodels-and-cross-validation"><span class="header-section-number">15.6</span> Tidymodels and Cross-validation</a>
  <ul>
  <li><a href="#split-data-into-train-vs.-test" id="toc-split-data-into-train-vs.-test" class="nav-link" data-scroll-target="#split-data-into-train-vs.-test"><span class="header-section-number">15.6.1</span> Split data into train vs.&nbsp;test</a></li>
  <li><a href="#construct-features-and-create-model-recipe" id="toc-construct-features-and-create-model-recipe" class="nav-link" data-scroll-target="#construct-features-and-create-model-recipe"><span class="header-section-number">15.6.2</span> Construct features and create model recipe</a></li>
  <li><a href="#choose-type-of-model-to-run" id="toc-choose-type-of-model-to-run" class="nav-link" data-scroll-target="#choose-type-of-model-to-run"><span class="header-section-number">15.6.3</span> Choose type of model to run</a></li>
  <li><a href="#create-a-workflow-that-combines-the-model-and-recipe" id="toc-create-a-workflow-that-combines-the-model-and-recipe" class="nav-link" data-scroll-target="#create-a-workflow-that-combines-the-model-and-recipe"><span class="header-section-number">15.6.4</span> Create a workflow that combines the model and recipe</a></li>
  <li><a href="#cross-validation-1" id="toc-cross-validation-1" class="nav-link" data-scroll-target="#cross-validation-1"><span class="header-section-number">15.6.5</span> Cross-validation</a></li>
  <li><a href="#fitting-the-model" id="toc-fitting-the-model" class="nav-link" data-scroll-target="#fitting-the-model"><span class="header-section-number">15.6.6</span> Fitting the model</a></li>
  <li><a href="#evaluating-model-performance" id="toc-evaluating-model-performance" class="nav-link" data-scroll-target="#evaluating-model-performance"><span class="header-section-number">15.6.7</span> Evaluating model performance</a></li>
  <li><a href="#finalize-workflow" id="toc-finalize-workflow" class="nav-link" data-scroll-target="#finalize-workflow"><span class="header-section-number">15.6.8</span> Finalize workflow</a></li>
  <li><a href="#applying-model-to-test-data" id="toc-applying-model-to-test-data" class="nav-link" data-scroll-target="#applying-model-to-test-data"><span class="header-section-number">15.6.9</span> Applying model to test data</a></li>
  <li><a href="#trying-out-classifier-on-completely-new-data" id="toc-trying-out-classifier-on-completely-new-data" class="nav-link" data-scroll-target="#trying-out-classifier-on-completely-new-data"><span class="header-section-number">15.6.10</span> Trying out classifier on completely new data</a></li>
  </ul></li>
  <li><a href="#extending-machine-learning" id="toc-extending-machine-learning" class="nav-link" data-scroll-target="#extending-machine-learning"><span class="header-section-number">15.7</span> Extending Machine Learning</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="predict" class="quarto-section-identifier"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Prediction and Classification</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This section will provide a brief introduction to tools related to the goals of prediction and classification.</p>
<p>In the social sciences, we often have one of a few goals in mind:</p>
<ul>
<li>Describe</li>
<li>Explain, evaluate, and recommend <span class="math inline">\(\rightarrow\)</span> Causality</li>
<li>Discover and Predict</li>
</ul>
<p>Most of the tools we have been working on thus far have focused on first describing our data and then conducting hypothesis tests through different types of regression, in order to assess a deductive hypothesis, <em>explaining</em> the relationship between two variables.</p>
<p>Here, we are going to turn to the third goal above.</p>
<p>Some supplemental resources for this section include the following R packages:</p>
<ul>
<li>I highly recommend this <a href="https://supervised-ml-course.netlify.app/">online interactive course</a> (free- amazing!) from Jilia Silge which walks through a newer package, <code>tidymodels</code> similar to caret, that can apply several different types of machine learning models. It draws on the fundamentals covered in this section but adds more advanced techniques. Here is an additional detailed tutorial on this package <a href="https://hansjoerg.me/2020/02/09/tidymodels-for-machine-learning/">here</a> and <a href="https://www.r-bloggers.com/2020/03/machine-learning-with-tidymodels-2/">here</a>.</li>
<li><code>caret</code> <a href="http://topepo.github.io/caret/index.html">package</a> and <a href="https://www.r-project.org/conferences/useR-2013/Tutorials/kuhn/user_caret_2up.pdf%7D%7Bpresentation">presentation</a></li>
<li><code>RTextTools</code> (may or may not be updated) <a href="https://cran.r-project.org/web/packages/RTextTools/index.html">here</a> and <a href="https://journal.r-project.org/archive/2013-1/collingwood-jurka-boydstun-etal.pdf%7D%7Bsummary">here</a></li>
</ul>
<section id="overview-of-prediction-and-classification" class="level2" data-number="15.1">
<h2 data-number="15.1" class="anchored" data-anchor-id="overview-of-prediction-and-classification"><span class="header-section-number">15.1</span> Overview of Prediction and Classification</h2>
<p>When we predict something, we are estimating some unknown using information we do know and trying to do so as accurately and precisely as possible.</p>
<ul>
<li>Often prediction involves classification– predicting a categorical outcome (e.g., prediction of who wins vs.&nbsp;who loses)</li>
</ul>
<p>Some social science examples of this might include</p>
<p><img src="images/instagramhate.png" class="img-fluid"></p>
<ul>
<li>Trying to detect hate speech online</li>
<li>Trying to flag “fake news” and other misinformation</li>
<li>Trying to forecast the results of an election</li>
<li>Trying to classify a large amount of text into subject or topic categories for analysis</li>
</ul>
<section id="how-to-predict-or-classify" class="level3" data-number="15.1.1">
<h3 data-number="15.1.1" class="anchored" data-anchor-id="how-to-predict-or-classify"><span class="header-section-number">15.1.1</span> How to predict or classify</h3>
<p>Goal: Estimate/guess some unknown using information we have – and do so as accurately and precisely as possible.</p>
<ol type="1">
<li>Choose an approach
<ul>
<li>Using an observed (known) measure as a direct proxy to predict an outcome (e.g., a dictionary)</li>
<li>Using one or more observed (known) measures in a (often, regression) model to predict an outcome</li>
<li>Using a model to automatically select the measures to use for predicting an outcome</li>
</ul></li>
<li>Assess accuracy and precision in-sample and out-of-sample using some sample “training” data where you do know the right answer (“ground truth”).
<ul>
<li>Prediction error: <span class="math inline">\(Truth - Prediction\)</span></li>
<li>Bias: Average prediction error: <span class="math inline">\(\text{mean}(Truth - Prediction)\)</span>
<ul>
<li>A prediction is `unbiased’ if the bias is zero (if the prediction is on average true)</li>
</ul></li>
<li>In regression: R-squared or Root-mean squared error
<ul>
<li>RMSE is like `absolute’ error– the average magnitude of the prediction error</li>
</ul></li>
<li>For classification: Confusion Matrix
<ul>
<li>A cross-tab of predictions you got correct vs.&nbsp;predictions you got wrong (misclassified)</li>
<li>Gives you true positives and true negatives vs.&nbsp;false positives and false negatives</li>
</ul></li>
</ul></li>
<li>Repeat steps 1 and 2 until you are confident in your method for predicting or classifying.</li>
<li>Apply to completely unknown data.</li>
</ol>
</section>
</section>
<section id="in-sample-vs.-out-of-sample" class="level2" data-number="15.2">
<h2 data-number="15.2" class="anchored" data-anchor-id="in-sample-vs.-out-of-sample"><span class="header-section-number">15.2</span> In-sample vs.&nbsp;Out-of-Sample</h2>
<p>Problem: Models that fit our existing (“in-sample”) data might not be the best for predicting out-of-sample data. Issues with variability and overfitting.</p>
<ul>
<li>There may be idiosyncratic features of the data for which we do know the ground truth (e.g., outliers, different levels of variability) that could lead to poor predictions. This can lead to overfitting– predicting your particular dataset reaaaaaallly well, but any other data, more poorly.</li>
<li>Our training data could be unrepresentative of the population in some way</li>
</ul>
<p>For example, many AI tools suffer from gender and/or racial biases due to unrepresentative training data. If most of the data used to train a speech detection or facial recognition tool was trained on white faces/ white voices, it may have poor accuracy for other groups.</p>
<p><img src="images/speecherrors.png" class="img-fluid"></p>
<p>Solutions:</p>
<ul>
<li>Choose your training data wisely!</li>
<li>Search for systematic biases along key variables (instead of aggregate accuracy, also look for accuracy measures by subgroups)</li>
<li>Use out-of-sample predictions/classification tests to help avoid overfitting
<ul>
<li>Split data into train vs.&nbsp;test and/or do this repeatedly with</li>
<li>Cross-validation</li>
</ul></li>
</ul>
</section>
<section id="cross-validation" class="level2" data-number="15.3">
<h2 data-number="15.3" class="anchored" data-anchor-id="cross-validation"><span class="header-section-number">15.3</span> Cross-Validation</h2>
<p>Cross-Validation is an approach to address overfitting issues</p>
<ul>
<li>Take data for which you know the answer – we call this “training data”</li>
<li>Randomly subset out a portion of the training data. This will become our “test” data.</li>
<li>Develop a model based on the training data.</li>
<li>Test the accuracy of the model on the test data (out-of-sample data that was not used to train the model).</li>
<li>Repeat process for different portions of the data.</li>
</ul>
<p>Goal: See how well our model will generalize to new data (data the model hasn’t seen).</p>
<section id="k-fold-cross-validation" class="level3" data-number="15.3.1">
<h3 data-number="15.3.1" class="anchored" data-anchor-id="k-fold-cross-validation"><span class="header-section-number">15.3.1</span> k-fold cross-validation</h3>
<p>Divide your data into folds (how many <span class="math inline">\(k\)</span> depends on how much data you have)</p>
<ul>
<li>Fit your model to <span class="math inline">\(k-1\)</span> folds</li>
<li>See how well your model predicts the data in the <span class="math inline">\(k\)</span>th fold.</li>
<li>Can repeat, leaving out a different fold each time</li>
</ul>
</section>
<section id="leave-one-out-cross-validation" class="level3" data-number="15.3.2">
<h3 data-number="15.3.2" class="anchored" data-anchor-id="leave-one-out-cross-validation"><span class="header-section-number">15.3.2</span> Leave-one-out cross-validation</h3>
<p>Best for smaller data</p>
<ul>
<li>Fit your model to all but one observation in your data</li>
<li>See how well your model predicts the left-out observation</li>
<li>Can repeat, continuing to leave out one observation each time</li>
</ul>
</section>
</section>
<section id="examples-of-prediction-and-classification" class="level2" data-number="15.4">
<h2 data-number="15.4" class="anchored" data-anchor-id="examples-of-prediction-and-classification"><span class="header-section-number">15.4</span> Examples of Prediction and Classification</h2>
<p>You may be wondering why we are covering these topics in a maximum likelihood course. Well, one of the most fundamental types of classification relies on logistic regression. We are just going to reframe the tools we have already learned for a different purpose.</p>
<p>Let’s use an example with the <code>donation</code> data from <a href="https://ktmccabe.github.io/mlebook/week-12-exercise.html">12.7</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rio)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>don <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"https://github.com/ktmccabe/teachingdata/blob/main/donation.dta?raw=true"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Recall that a key outcome variable here was <code>donation</code> indicating if a particular member of the donorate donated to a given senator (=1) or not (=0)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(don<span class="sc">$</span>donation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    0     1 
61533  2377 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>don<span class="sc">$</span>donation <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(don<span class="sc">$</span>donation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Can we predict whether someone will donate to a Senator?</p>
<p>Outcome: <code>donation</code> (1 or 0), binary variable = binary classifier</p>
<ol type="1">
<li>Choose an approach: Build a model (e.g., logistic regression)</li>
<li>Train the model</li>
<li>Assess accuracy
<ul>
<li>Within sample and test model using cross-validation out-of-sample</li>
</ul></li>
<li>If we were very satisfied with our model, we could apply the model to data for which we do not know the answer in the future.
<ul>
<li>If you were a campaign, could you predict who will donate?</li>
</ul></li>
</ol>
<p>Let’s go!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">## build a model (choose "features" you think will be good for prediction)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="do">## you will want to remove missing data first</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>donsub <span class="ot">&lt;-</span> don[, <span class="fu">c</span>(<span class="st">"donation"</span>, <span class="st">"NetWorth"</span>, <span class="st">"Edsum"</span>)]</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>donsub <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(donsub)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(donation <span class="sc">~</span> NetWorth <span class="sc">+</span> Edsum, </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>), <span class="at">data =</span> donsub)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In-Sample Accuracy Assessments</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">## generate probability of donation for each observation</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>donsub<span class="sc">$</span>prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="do">## set a prediction threshold</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>donsub<span class="sc">$</span>pred <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(donsub<span class="sc">$</span>prob <span class="sc">&gt;</span> <span class="fl">0.05</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="do">## accuracy- proportion where prediction matches reality</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(donsub<span class="sc">$</span>pred <span class="sc">==</span> donsub<span class="sc">$</span>donation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7374135</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## confusion matrix</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="at">truth =</span> donsub<span class="sc">$</span>donation, <span class="at">predicted =</span> donsub<span class="sc">$</span>pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     predicted
truth     0     1
    0 38485 12754
    1  1203   710</code></pre>
</div>
</div>
<p>There are different measures for accuracy that focus on particular types of errors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## where did we miss</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="at">actual =</span> donsub<span class="sc">$</span>donation, <span class="at">pred =</span> donsub<span class="sc">$</span>pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      pred
actual     0     1
     0 38485 12754
     1  1203   710</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>truepos <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">actual =</span> donsub<span class="sc">$</span>donation, <span class="at">pred =</span> donsub<span class="sc">$</span>pred)[<span class="dv">2</span>,<span class="dv">2</span>]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>falsepos <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">actual =</span> donsub<span class="sc">$</span>donation, <span class="at">pred =</span> donsub<span class="sc">$</span>pred)[<span class="dv">1</span>,<span class="dv">2</span>]</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>trueneg <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">actual =</span> donsub<span class="sc">$</span>donation, <span class="at">pred =</span> donsub<span class="sc">$</span>pred)[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>falseneg <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">actual =</span> donsub<span class="sc">$</span>donation, <span class="at">pred =</span> donsub<span class="sc">$</span>pred)[<span class="dv">2</span>,<span class="dv">1</span>]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="do">## precision</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>precision <span class="ot">&lt;-</span> truepos<span class="sc">/</span>(truepos <span class="sc">+</span> falsepos)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="do">## specificity</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>specificity <span class="ot">&lt;-</span> trueneg <span class="sc">/</span> (trueneg <span class="sc">+</span> falsepos)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="do">## false positive rate</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>falsepos <span class="ot">&lt;-</span> falsepos<span class="sc">/</span>(trueneg<span class="sc">+</span> falsepos)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="do">## recall aka sensitivity</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>recall <span class="ot">&lt;-</span> truepos<span class="sc">/</span>(truepos <span class="sc">+</span> falseneg)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="do">## f-score, combination of precision/recall</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>F1 <span class="ot">&lt;-</span> (<span class="dv">2</span> <span class="sc">*</span> precision <span class="sc">*</span> recall) <span class="sc">/</span> (precision <span class="sc">+</span> recall)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>See <a href="https://towardsdatascience.com/accuracy-recall-precision-f-score-specificity-which-to-optimize-on-867d3f11124">this post</a> for more details and guidance on which one to choose.</p>
<p>Another common way to assess accuracy is through an ROC curve</p>
<p>ROC curves plot the true positive rate/precision (y) vs.&nbsp;1 - false positive (x) rates. Want the curve to be away from the diagonal, increasing the area under the curive (AUC).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("pROC")</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>ROC <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="at">response =</span> donsub<span class="sc">$</span>donation,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">predictor =</span> donsub<span class="sc">$</span>pred)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ROC, <span class="at">print.thres =</span> <span class="st">"best"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="15-PredictionClassification_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">auc</span>(ROC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Area under the curve: 0.5611</code></pre>
</div>
</div>
<p>For more information, see <a href="http://fouryears.eu/2011/10/12/roc-area-under-the-curve-explained/">here</a>.</p>
</section>
<section id="continuous-example" class="level2" data-number="15.5">
<h2 data-number="15.5" class="anchored" data-anchor-id="continuous-example"><span class="header-section-number">15.5</span> Continuous Example</h2>
<p>Let’s now try an example with a continuous outcome: How much will someone donate to a Senator? One way to judge accuracy of a linear model is the root mean squared error</p>
<p>One basic approach would be to use a linear regression model. Other than that, it’s the same process as before, but we will use a different assessment for accuracy.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(total_donation <span class="sc">~</span> NetWorth <span class="sc">+</span> Edsum, <span class="at">data =</span> don)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Root mean squared error</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(<span class="fu">residuals</span>(fit)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>fit<span class="sc">$</span>df.residual)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>rmse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 324.081</code></pre>
</div>
</div>
</section>
<section id="tidymodels-and-cross-validation" class="level2" data-number="15.6">
<h2 data-number="15.6" class="anchored" data-anchor-id="tidymodels-and-cross-validation"><span class="header-section-number">15.6</span> Tidymodels and Cross-validation</h2>
<p>We are going to use a package called <code>tidymodels</code> to implement this process.</p>
<ul>
<li>This package allows users to employ a variety of different machine learning models with only minor adjustments to the coding syntax.</li>
<li>It also integrates additional pre-processing and post-fit model validation tools to make training and testing models easier.
<ul>
<li>We will explore tools for cross-validation and downsampling.</li>
</ul></li>
<li>Similar packages exist, such as the <a href="https://topepo.github.io/caret/index.html"><code>caret</code> R package</a>. Many machine learning models also have their own standalone R packages you can explore.</li>
</ul>
<section id="split-data-into-train-vs.-test" class="level3" data-number="15.6.1">
<h3 data-number="15.6.1" class="anchored" data-anchor-id="split-data-into-train-vs.-test"><span class="header-section-number">15.6.1</span> Split data into train vs.&nbsp;test</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ ggplot2 3.4.2     ✔ purrr   1.0.2
✔ tibble  3.2.1     ✔ dplyr   1.1.2
✔ tidyr   1.3.0     ✔ stringr 1.5.0
✔ readr   2.1.2     ✔ forcats 1.0.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ────────────────────────────────────── tidymodels 0.2.0 ──</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ broom        1.0.5     ✔ rsample      0.1.1
✔ dials        1.0.0     ✔ tune         0.2.0
✔ infer        1.0.2     ✔ workflows    0.2.6
✔ modeldata    0.1.1     ✔ workflowsets 0.2.1
✔ parsnip      0.2.1     ✔ yardstick    1.0.0
✔ recipes      0.2.0     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──
✖ scales::discard() masks purrr::discard()
✖ dplyr::filter()   masks stats::filter()
✖ recipes::fixed()  masks stringr::fixed()
✖ dplyr::lag()      masks stats::lag()
✖ yardstick::spec() masks readr::spec()
✖ recipes::step()   masks stats::step()
• Learn how to get started at https://www.tidymodels.org/start/</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(textrecipes)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(themis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'themis'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:recipes':

    step_downsample, step_upsample</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(yardstick)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Matrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'Matrix'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:tidyr':

    expand, pack, unpack</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loaded glmnet 4.1-4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Split into train vs. test</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>df_split <span class="ot">&lt;-</span> donsub <span class="sc">%&gt;%</span> <span class="fu">initial_split</span>(<span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>df_train <span class="ot">&lt;-</span> <span class="fu">training</span>(df_split)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>df_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(df_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="construct-features-and-create-model-recipe" class="level3" data-number="15.6.2">
<h3 data-number="15.6.2" class="anchored" data-anchor-id="construct-features-and-create-model-recipe"><span class="header-section-number">15.6.2</span> Construct features and create model recipe</h3>
<p>We now need to construct the features of our tweets that we will use to predict whether or not a tweet is uncivil. Because we have text as our data, our approach will be to use the presence and absence of certain words and characters (and their frequency) as the predictions.</p>
<ul>
<li>In <code>tidymodels</code>, we can specify these steps as part of a <code>recipe</code>. In a <code>recipe</code>, you write a formula that is similar to the syntax of standard regression models in R, where you have your outcome <code>y ~ features, data</code>.</li>
<li>Following the initial recipe line, we can then add steps to pre-process and mutate the variables that will be include in the model.
<ul>
<li>The steps we include below are at our discretion. You may iterate the process changing the pre-processing steps to try to improve your model performance.</li>
</ul></li>
<li>There are many additional pre-processing arguments you can add to a <a href="https://www.tidymodels.org/find/recipes/">recipe</a>.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="do">## recipe for pre-processing variables and text</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>df_rec <span class="ot">&lt;-</span>   <span class="fu">recipe</span>(donation <span class="sc">~</span> NetWorth <span class="sc">+</span> Edsum, <span class="at">data =</span> df_train) <span class="sc">%&gt;%</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Downsample based on outcome</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  themis<span class="sc">::</span><span class="fu">step_downsample</span>(donation) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the last line, we implement “downsampling” from the <code>themis</code> package. You will not always want to include this line. What downsampling does is adjust the balance of the outcome categories we have in the data by randomly removing rows from training data, so that there is a roughly even balance between tweets that are vs.&nbsp;are not “uncivil.” Without this type of adjustment, a model may be prone to simply guess whichever class is disproportionately represented if there is an extreme lack of balance between categories.</p>
</section>
<section id="choose-type-of-model-to-run" class="level3" data-number="15.6.3">
<h3 data-number="15.6.3" class="anchored" data-anchor-id="choose-type-of-model-to-run"><span class="header-section-number">15.6.3</span> Choose type of model to run</h3>
<p>At this point, we can specify different types of models we may want to try out as part of the classification process. This represents an advantage of the <code>tidymodels</code> package, as the syntax is roughly the same across model types. In tidymodels, you specify models using three concepts.</p>
<ul>
<li><code>type</code> of models such as logistic regression, decision tree models,random forests, and so forth.</li>
<li><code>mode</code> includes options regression and classification; some model types support either of these while some only have one mode. With a dichotomous outcome, we are in classification world.</li>
<li><code>engine</code> is the computational tool to fit the model. You will notice <code>glmnet</code> below</li>
</ul>
<p>Some models require you to install additional R packages for their implementation. This is why we installed <code>glmnet</code> for the logistic regressions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Specify model: Three examples</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="do">## A penalized logistic regression model</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>logit_mod <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glm"</span>)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="do">## A penalized logistic model with penalty tuning</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>logit_tune <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>(<span class="at">penalty=</span><span class="fu">tune</span>(), <span class="at">mixture =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>lambda_grid <span class="ot">&lt;-</span> <span class="fu">grid_regular</span>(<span class="fu">penalty</span>(), <span class="at">levels =</span> <span class="dv">30</span>)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Random Forest</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>rf_spec <span class="ot">&lt;-</span> </span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rand_forest</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we could include arguments <code>penalty</code> and <code>mixture</code> in the <code>logistic_reg</code> function. These are specific to this type of model. In this type of penalized logistic regression, we have a penalty that serves to penalize features used for prediction that do not have much predictive power.</p>
<ul>
<li>How harsh should this penalty be? Well, this is where the <code>tune()</code> argument comes in during the second approach. We can choose the value of the penalty based on model performance. The <code>grid_regular</code> function tells R that we want to test out 30 different values of this penalty.</li>
</ul>
</section>
<section id="create-a-workflow-that-combines-the-model-and-recipe" class="level3" data-number="15.6.4">
<h3 data-number="15.6.4" class="anchored" data-anchor-id="create-a-workflow-that-combines-the-model-and-recipe"><span class="header-section-number">15.6.4</span> Create a workflow that combines the model and recipe</h3>
<p>Now that we have prepared our data and model formula, we are ready to put things together using a <code>workflow</code>. At this point, we still haven’t actually fit a model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="do">## workflow penalized logit</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>df_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(df_rec) <span class="sc">%&gt;%</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(logit_mod)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="do">## workflow for the tuning specification</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>df_wft <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(df_rec) <span class="sc">%&gt;%</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(logit_tune)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="do">## workflow for random forest</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>df_wfrf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(df_rec) <span class="sc">%&gt;%</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rf_spec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="cross-validation-1" class="level3" data-number="15.6.5">
<h3 data-number="15.6.5" class="anchored" data-anchor-id="cross-validation-1"><span class="header-section-number">15.6.5</span> Cross-validation</h3>
<p>Thus far, we have just broken up our data into two portions, one for training and one for testing. Many times, we might want to perform more rigorous testing of our data. One approach for doing so is called <span class="math inline">\(k\)</span>-fold cross-validation.</p>
<p>For this example, we are going to keep our <code>df_test</code> data separate as a “holdout” sample that is never used to train the classifier. However, we are going to further break up our training data <code>df_train</code> into five separate portions (5-fold cross-validation is also common).</p>
<p><img src="images/cv.png" class="img-fluid" style="width:60.0%"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="do">## cross-validation</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>df_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(df_train, <span class="at">v=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Each time we run the classifier, we will use all but one fold (four folds) of data and then test the results on the “left out” fold of data.</li>
<li>We repeat the process for a total of five times, leaving a different fold out for testing each time.
<ul>
<li>Note: It is also possible to further repeat this entire process, by repeatedly resampling the data so that observations are shuffled into different folds.</li>
</ul></li>
<li>Our performance metrics are then a summary of five tests instead of just one test.</li>
</ul>
</section>
<section id="fitting-the-model" class="level3" data-number="15.6.6">
<h3 data-number="15.6.6" class="anchored" data-anchor-id="fitting-the-model"><span class="header-section-number">15.6.6</span> Fitting the model</h3>
<p>Here are examples of fitting different models. For now, do not run all of them, as they each take a decent amount of computational time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Fitting model on training data</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Basic model fit to training data as one sample, no cross-validation</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>df_basic <span class="ot">&lt;-</span> df_wf <span class="sc">%&gt;%</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> df_train)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Cross-validation on penalized logistic model</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>my_metrics <span class="ot">&lt;-</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(accuracy, ppv, npv)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>df_cv <span class="ot">&lt;-</span> <span class="fu">fit_resamples</span>(</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  df_wf,</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  df_folds,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>),</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> my_metrics</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="do">## Tuning the penalized logistic model</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>df_rs <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>  df_wft,</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>  df_folds,</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid=</span>lambda_grid, <span class="co"># note the use of the grid here</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>),</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> my_metrics</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="do">## Random forest with cross-validation</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>df_rf <span class="ot">&lt;-</span> <span class="fu">fit_resamples</span>(</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>  df_wfrf,</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>  df_folds,</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>),</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> my_metrics</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="evaluating-model-performance" class="level3" data-number="15.6.7">
<h3 data-number="15.6.7" class="anchored" data-anchor-id="evaluating-model-performance"><span class="header-section-number">15.6.7</span> Evaluating model performance</h3>
<p>Did we get things right?</p>
<ul>
<li>There are many ways to answer this question.
<ul>
<li>Accuracy– how many did we get right out of the total cases?</li>
<li>Confusion Matrix– where did we go right vs.&nbsp;wrong?
<ul>
<li>False Positive, True Positive, False Negative, True Negatives</li>
</ul></li>
<li>Additional metrics that focus on particular types of error rates</li>
</ul></li>
</ul>
<p>Your choice of metric depends on what you see as best for your use case.</p>
<p><strong><em>Evaluating on training data</em></strong></p>
<p>For the models without cross-validation, we can use the <code>predict()</code> function to classify our training data into uncivil or not uncivil tweets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add prediction columns to training data</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> df_train  <span class="sc">%&gt;%</span> <span class="fu">select</span>(donation) <span class="sc">%&gt;%</span> </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(df_basic <span class="sc">%&gt;%</span> </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">predict</span>(<span class="at">new_data =</span> df_train))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then evaluate these predictions against the ground truth from the <code>uncvil</code> column in our original training data. Below is a confusion matrix that shows where we were right vs.&nbsp;wrong.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> donation, <span class="at">estimate =</span> .pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction     0     1
         0 24058   578
         1 16938   947</code></pre>
</div>
</div>
<p>We can then quantify different types of performance using our metrics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>eval_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(accuracy, ppv, npv)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">eval_metrics</span>(<span class="at">data =</span> results, </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">truth =</span> donation, </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">estimate =</span> .pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  .metric  .estimator .estimate
  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
1 accuracy binary        0.588 
2 ppv      binary        0.977 
3 npv      binary        0.0529</code></pre>
</div>
</div>
<p><strong><em>Evaluating with cross-validation</em></strong></p>
<p>When we have used cross-validation and/or tuning, we can apply the <code>collect_metrics</code> function to our models to evaluate performance across the folds of our data. Here, the results represent performance averaged across the five tests of our data, instead of just a single test.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="do">## cross-validated logistic</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>resultscv <span class="ot">&lt;-</span> <span class="fu">collect_metrics</span>(df_cv)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>resultscv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  .metric  .estimator   mean     n std_err .config             
  &lt;chr&gt;    &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
1 accuracy binary     0.603      5 0.00957 Preprocessor1_Model1
2 npv      binary     0.0534     5 0.00226 Preprocessor1_Model1
3 ppv      binary     0.976      5 0.00115 Preprocessor1_Model1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="do">## cross-validated random forest</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>resultsrf <span class="ot">&lt;-</span> <span class="fu">collect_metrics</span>(df_rf)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>resultsrf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  .metric  .estimator   mean     n  std_err .config             
  &lt;chr&gt;    &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt; &lt;chr&gt;               
1 accuracy binary     0.624      5 0.00837  Preprocessor1_Model1
2 npv      binary     0.0563     5 0.00203  Preprocessor1_Model1
3 ppv      binary     0.977      5 0.000962 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>When you have tuned a model, you can then decide on the value of the “hyperparameter” based on a chosen metric, such as accuracy.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>resultstuning <span class="ot">&lt;-</span> <span class="fu">collect_metrics</span>(df_rs)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>chosen_acc <span class="ot">&lt;-</span> df_rs <span class="sc">%&gt;%</span> <span class="fu">select_best</span>(<span class="st">"accuracy"</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>chosen_acc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
       penalty .config              
         &lt;dbl&gt; &lt;chr&gt;                
1 0.0000000001 Preprocessor1_Model01</code></pre>
</div>
</div>
</section>
<section id="finalize-workflow" class="level3" data-number="15.6.8">
<h3 data-number="15.6.8" class="anchored" data-anchor-id="finalize-workflow"><span class="header-section-number">15.6.8</span> Finalize workflow</h3>
<p>Once we have settled on a model and workflow, we want to finalize it by fitting it to the entire training data.</p>
<p>Below are two examples:</p>
<p>When you do not have tuning, you can fit the model to the entire training data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Saving the random forest model</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>final_wfrf <span class="ot">&lt;-</span> <span class="fu">fit</span>(df_wfrf, df_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When you have tuning, you want to use <code>finalize_workflow</code> to make sure you save the tuned parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Saving the tuned workflow-- note we include are chosen lambda</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>final_wft <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(df_wft, chosen_acc)  <span class="sc">%&gt;%</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data=</span>df_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could save this workflow as an R object, which would allow us to store it as a classifier for future use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="do">## saving decision tree</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(final_wfrf, <span class="at">file =</span> <span class="st">"donationclassifierRF.RDS"</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="do">## saving tuned workflow</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(final_wft, <span class="at">file =</span> <span class="st">"donationclassifierT.RDS"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="applying-model-to-test-data" class="level3" data-number="15.6.9">
<h3 data-number="15.6.9" class="anchored" data-anchor-id="applying-model-to-test-data"><span class="header-section-number">15.6.9</span> Applying model to test data</h3>
<p>At this point, our model still has not seen our test data. This makes it an especially difficult test for the model. Here is an example using our tuned penalized logistic regression model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>testres <span class="ot">&lt;-</span> df_test <span class="sc">%&gt;%</span> <span class="fu">select</span>(donation) <span class="sc">%&gt;%</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(final_wft, <span class="at">new_data=</span>df_test))</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>testres_cf <span class="ot">&lt;-</span> testres <span class="sc">%&gt;%</span> </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> donation, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>test_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(accuracy, ppv, npv)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="fu">test_metrics</span>(<span class="at">data =</span> testres, <span class="at">truth =</span> donation, <span class="at">estimate =</span> .pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  .metric  .estimator .estimate
  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
1 accuracy binary        0.586 
2 ppv      binary        0.974 
3 npv      binary        0.0506</code></pre>
</div>
</div>
</section>
<section id="trying-out-classifier-on-completely-new-data" class="level3" data-number="15.6.10">
<h3 data-number="15.6.10" class="anchored" data-anchor-id="trying-out-classifier-on-completely-new-data"><span class="header-section-number">15.6.10</span> Trying out classifier on completely new data</h3>
<p>For the classifier to work, the new data must contain the same primary feature columns as the data used to build the model.</p>
<p>Below we construct a dataframe with the variable <code>text</code> as a column. These examples are taken from Pablo Barbera’s GitHub <a href="https://github.com/pablobarbera/incivility-sage-open">demonstration</a> of the authors’ original classifier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>newdf <span class="ot">&lt;-</span>  <span class="fu">data.frame</span>(<span class="at">NetWorth =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>,<span class="dv">3</span>),</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">Edsum =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">6</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Does our classifier identify these phrases as uncivil?</p>
<p>We load our saved classifier and predict incivility using our new data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="do">## cross-validated tree model</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>donationclassRF <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"donationclassifierRF.RDS"</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(donationclassRF, newdf, <span class="at">type =</span> <span class="st">"class"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 1
  .pred_class
  &lt;fct&gt;      
1 0          
2 0          
3 0          </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Tune penalized logistic</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>donationclassT <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"donationclassifierT.RDS"</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(donationclassT, newdf, <span class="at">type =</span> <span class="st">"class"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 1
  .pred_class
  &lt;fct&gt;      
1 0          
2 0          
3 0          </code></pre>
</div>
</div>
</section>
</section>
<section id="extending-machine-learning" class="level2" data-number="15.7">
<h2 data-number="15.7" class="anchored" data-anchor-id="extending-machine-learning"><span class="header-section-number">15.7</span> Extending Machine Learning</h2>
<p>How do I know which variables matter? Examples of more complex machine learning methods.</p>
<ul>
<li>Random forests</li>
<li>Gradient boosting</li>
<li>LASSO</li>
<li>SVM</li>
</ul>
<p>Tradeoffs: Machine Learning as “black box”- see <a href="https://towardsdatascience.com/the-black-box-metaphor-in-machine-learning-4e57a3a1d2b0">here</a></p>
<p>There are nearly countless ways to use machine learning. See <a href="http://topepo.github.io/caret/train-models-by-tag.html">here</a>.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./14-SurvivalData.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Survival Data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./16-ModelTypesSummary.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Linear Models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>